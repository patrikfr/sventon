<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">

<!-- Application context definition for sventon DispatcherServlet -->

<beans default-lazy-init="false">

  <bean id="sventonDir" class="java.lang.String">
    <constructor-arg>
      <value>${java.io.tmpdir}/sventon/</value>
    </constructor-arg>
  </bean>

  <bean id="sventonCacheDir" class="java.lang.String">
    <constructor-arg>
      <value>${java.io.tmpdir}/sventon/cache/</value>
    </constructor-arg>
  </bean>

  <bean id="sventonExportDir" class="java.lang.String">
    <constructor-arg>
      <value>${java.io.tmpdir}/sventon/export/</value>
    </constructor-arg>
  </bean>

  <!-- Makes sure the directories are created -->
  <bean class="java.io.File" init-method="mkdirs">
    <constructor-arg>
      <ref local="sventonCacheDir"/>
    </constructor-arg>
  </bean>

  <bean class="java.io.File" init-method="mkdirs">
    <constructor-arg>
      <ref local="sventonExportDir"/>
    </constructor-arg>
  </bean>

  <bean id="defaultEncoding" class="java.lang.String">
    <constructor-arg>
      <value>UTF-8</value>
    </constructor-arg>
  </bean>

  <!-- property placeholder post-processor -->
  <bean id="placeholderConfig" class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer" />

  <bean id="configuration" class="de.berlios.sventon.config.ApplicationConfiguration">
    <property name="SVNConfigurationPath">
      <ref local="sventonDir"/>
    </property>
  </bean>

  <bean id="configurator" class="de.berlios.sventon.config.ApplicationConfigurator" >
    <constructor-arg index="0">
      <value>/sventon.properties</value>
    </constructor-arg>
    <constructor-arg index="1">
      <ref local="configuration"/>
    </constructor-arg>
  </bean>

  <bean id="svnBaseCommandValidator" class="de.berlios.sventon.web.command.SVNBaseCommandValidator"/>

  <bean id="configCommandValidator" class="de.berlios.sventon.web.command.ConfigCommandValidator">
    <property name="configPath">
      <ref local="sventonDir"/>
    </property>
  </bean>

  <bean id="repositoryService" class="de.berlios.sventon.service.RepositoryServiceImpl">
    <property name="cache">
      <ref local="cacheBean"/>
    </property>
  </bean>

  <bean id="abstractController" abstract="true">
    <property name="configuration">
      <ref local="configuration"/>
    </property>
    <property name="cache">
      <ref local="cacheBean"/>
    </property>
    <property name="revisionObservable">
      <ref local="revisionObservable"/>
    </property>
    <property name="repositoryService">
      <ref local="repositoryService"/>
    </property>
  </bean>

  <bean id="repoBrowserController" class="de.berlios.sventon.web.ctrl.RepoBrowserController"
        parent="abstractController">
    <property name="validator">
      <ref local="svnBaseCommandValidator"/>
    </property>
  </bean>

  <bean id="showLockController" class="de.berlios.sventon.web.ctrl.ShowLockController" parent="abstractController">
    <property name="validator">
      <ref local="svnBaseCommandValidator"/>
    </property>
  </bean>

  <bean id="rssController" class="de.berlios.sventon.web.ctrl.xml.RSSController">
    <property name="configuration">
      <ref local="configuration"/>
    </property>
    <property name="mimeType">
      <value>application/xml; charset=UTF-8</value>
    </property>
    <property name="feedItemCount">
      <value>20</value>
    </property>
    <property name="feedGenerator">
      <ref local="syndFeedGenerator"/>
    </property>
    <property name="repositoryService">
      <ref local="repositoryService"/>
    </property>
  </bean>

  <bean id="syndFeedGenerator" class="de.berlios.sventon.rss.SyndFeedGenerator">
    <property name="feedType">
      <value>rss_2.0</value>
    </property>
    <property name="logMessageLength">
      <value>40</value>
    </property>
  </bean>

  <bean id="latestInfoController" class="de.berlios.sventon.web.ctrl.xml.ShowLatestCommitInfoController">
    <property name="configuration">
      <ref local="configuration"/>
    </property>
    <property name="encoding">
      <ref local="defaultEncoding"/>
    </property>
    <property name="repositoryService">
      <ref local="repositoryService"/>
    </property>
    <property name="datePattern">
      <value>yyyy-MM-dd HH:mm:ss</value>
    </property>
  </bean>

  <bean id="revInfoController" class="de.berlios.sventon.web.ctrl.ShowRevisionInfoController"
        parent="abstractController">
    <property name="validator">
      <ref local="svnBaseCommandValidator"/>
    </property>
  </bean>

  <bean id="goToController" class="de.berlios.sventon.web.ctrl.GoToController" parent="abstractController">
    <property name="validator">
      <ref local="svnBaseCommandValidator"/>
    </property>
  </bean>

  <bean id="showLogsController" class="de.berlios.sventon.web.ctrl.ShowLogController" parent="abstractController">
    <property name="validator">
      <ref local="svnBaseCommandValidator"/>
    </property>
    <!-- Number of log entries / page in logs view -->
    <property name="pageSize">
      <value>20</value>
    </property>
  </bean>

  <bean id="completionController" class="de.berlios.sventon.web.ctrl.xml.CompletionController"
        parent="abstractController">
    <property name="validator">
      <ref local="svnBaseCommandValidator"/>
    </property>
    <property name="encoding">
      <ref local="defaultEncoding"/>
    </property>
  </bean>

  <bean id="searchEntriesController" class="de.berlios.sventon.web.ctrl.SearchEntriesController" parent="abstractController">
    <property name="validator">
      <ref local="svnBaseCommandValidator"/>
    </property>
  </bean>

  <bean id="searchLogsController" class="de.berlios.sventon.web.ctrl.SearchLogsController" parent="abstractController">
    <property name="validator">
      <ref local="svnBaseCommandValidator"/>
    </property>
  </bean>

  <bean id="flattenController" class="de.berlios.sventon.web.ctrl.FlattenController" parent="abstractController">
    <property name="validator">
      <ref local="svnBaseCommandValidator"/>
    </property>
  </bean>

  <bean id="showFileController" class="de.berlios.sventon.web.ctrl.ShowFileController" parent="abstractController">
    <property name="archiveFileExtensionPattern">
      <value>(jar|zip|war|ear)</value>
    </property>
    <property name="colorer">
      <ref local="colorer"/>
    </property>
    <property name="validator">
      <ref local="svnBaseCommandValidator"/>
    </property>
    <property name="imageUtil">
      <ref local="imageUtil"/>
    </property>
  </bean>

  <bean id="showThumbnailsController" class="de.berlios.sventon.web.ctrl.ShowThumbnailsController"
        parent="abstractController">
    <property name="validator">
      <ref local="svnBaseCommandValidator"/>
    </property>
    <property name="imageUtil">
      <ref local="imageUtil"/>
    </property>
  </bean>

  <bean id="diffController" class="de.berlios.sventon.web.ctrl.DiffController" parent="abstractController">
    <property name="validator">
      <ref local="svnBaseCommandValidator"/>
    </property>
  </bean>

  <bean id="diffPreviousController" class="de.berlios.sventon.web.ctrl.DiffPreviousController"
        parent="abstractController">
    <property name="validator">
      <ref local="svnBaseCommandValidator"/>
    </property>
  </bean>

  <bean id="unifiedDiffController" class="de.berlios.sventon.web.ctrl.UnifiedDiffController"
        parent="abstractController">
    <property name="validator">
      <ref local="svnBaseCommandValidator"/>
    </property>
  </bean>

  <bean id="getController" class="de.berlios.sventon.web.ctrl.GetController" parent="abstractController">
    <property name="validator">
      <ref local="svnBaseCommandValidator"/>
    </property>
    <property name="imageUtil">
      <ref local="imageUtil"/>
    </property>
  </bean>

  <bean id="getThumbnailController" class="de.berlios.sventon.web.ctrl.GetThumbnailController" parent="abstractController">
    <property name="validator">
      <ref local="svnBaseCommandValidator"/>
    </property>
    <property name="imageUtil">
      <ref local="imageUtil"/>
    </property>
    <property name="objectCache">
      <ref local="objectCache"/>
    </property>
    <property name="imageFormatName">
      <value>png</value>
    </property>
    <property name="maxThumbnailSize">
      <value>200</value>
    </property>
  </bean>

  <bean id="zipController" class="de.berlios.sventon.web.ctrl.ZipController" parent="abstractController">
    <property name="validator">
      <ref local="svnBaseCommandValidator"/>
    </property>
    <property name="exportDir">
      <ref local="sventonExportDir"/>
    </property>
  </bean>

  <bean id="blameController" class="de.berlios.sventon.web.ctrl.BlameController" parent="abstractController">
    <property name="colorer">
      <ref local="colorer"/>
    </property>
    <property name="validator">
      <ref local="svnBaseCommandValidator"/>
    </property>
  </bean>

  <bean id="listInstancesController" class="de.berlios.sventon.web.ctrl.ListInstancesController">
    <property name="configuration">
      <ref local="configuration"/>
    </property>
  </bean>

  <bean id="startController" class="de.berlios.sventon.web.ctrl.StartController">
    <property name="configuration">
      <ref local="configuration"/>
    </property>
  </bean>

  <bean id="configurationController" class="de.berlios.sventon.web.ctrl.ConfigurationController">
    <property name="configuration">
      <ref local="configuration"/>
    </property>
    <property name="validator">
      <ref local="configCommandValidator"/>
    </property>
  </bean>

  <bean id="configurationSubmissionController" class="de.berlios.sventon.web.ctrl.ConfigurationSubmissionController">
    <property name="configuration">
      <ref local="configuration"/>
    </property>
    <property name="scheduler">
      <ref local="scheduler"/>
    </property>
  </bean>

  <bean id="clearSessionController" class="de.berlios.sventon.web.ctrl.ClearSessionController"/>

  <bean id="urlMapping" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
    <property name="mappings">
      <props>
        <!-- url mappings -->
        <prop key="/repobrowser.svn">repoBrowserController</prop>
        <prop key="/showlog.svn">showLogsController</prop>
        <prop key="/showfile.svn">showFileController</prop>
        <prop key="/clearsession.svn">clearSessionController</prop>
        <prop key="/searchentries.svn">searchEntriesController</prop>
        <prop key="/searchlogs.svn">searchLogsController</prop>
        <prop key="/blame.svn">blameController</prop>
        <prop key="/flatten.svn">flattenController</prop>
        <prop key="/get.svn">getController</prop>
        <prop key="/config.svn">configurationController</prop>
        <prop key="/submitconfig.svn">configurationSubmissionController</prop>
        <prop key="/listinstances.svn">listInstancesController</prop>
        <prop key="/start.svn">startController</prop>
        <prop key="/getthumb.svn">getThumbnailController</prop>
        <prop key="/showthumbs.svn">showThumbnailsController</prop>
        <prop key="/diff.svn">diffController</prop>
        <prop key="/diffprev.svn">diffPreviousController</prop>
        <prop key="/unifieddiff.svn">unifiedDiffController</prop>
        <prop key="/goto.svn">goToController</prop>
        <prop key="/revinfo.svn">revInfoController</prop>
        <prop key="/showlock.svn">showLockController</prop>
        <prop key="/zip.svn">zipController</prop>
        <!-- url mappings for xml producers -->
        <prop key="/rss.xml">rssController</prop>
        <prop key="/compl.xml">completionController</prop>
        <prop key="/latest.xml">latestInfoController</prop>
      </props>
    </property>
  </bean>

  <bean id="imageUtil" class="de.berlios.sventon.util.ImageUtil">
    <property name="mimeMappings">
      <props>
        <prop key="gif">image/gif</prop>
        <prop key="png">image/png</prop>
        <prop key="jpg">image/jpg</prop>
        <prop key="jpe">image/jpg</prop>
        <prop key="jpeg">image/jpg</prop>
      </props>
    </property>
  </bean>

  <bean id="objectCache" class="de.berlios.sventon.cache.ObjectCacheImpl" destroy-method="shutdown">
    <constructor-arg index="0">
      <value>sventon/cache/objectcache</value>
    </constructor-arg>
    <constructor-arg index="1">
      <value>10000</value>
    </constructor-arg>
    <constructor-arg index="2">
      <value>true</value>
    </constructor-arg>
    <constructor-arg index="3">
      <value>true</value>
    </constructor-arg>
    <constructor-arg index="4">
      <value>0</value>
    </constructor-arg>
    <constructor-arg index="5">
      <value>0</value>
    </constructor-arg>
    <constructor-arg index="6">
      <value>true</value>
    </constructor-arg>
    <constructor-arg index="7">
      <value>120</value>
    </constructor-arg>
  </bean>

  <!-- temporarily use the reloadable version (makes developing easier) -->
  <bean id="messageSource" class="org.springframework.context.support.ReloadableResourceBundleMessageSource">
    <property name="basename" value="/WEB-INF/classes/messages"/>
    <property name="useCodeAsDefaultMessage">
      <value>true</value>
    </property>
    <property name="cacheSeconds" value="0"/>
  </bean>

  <bean id="viewResolver" class="org.springframework.web.servlet.view.InternalResourceViewResolver">
    <property name="viewClass">
      <value>org.springframework.web.servlet.view.JstlView</value>
    </property>
    <property name="prefix">
      <value>/WEB-INF/jsp/</value>
    </property>
    <property name="suffix">
      <value>.jsp</value>
    </property>
  </bean>

  <!-- Gateway class for accessing the caches -->
  <!-- Bean configuration -->
  <bean id="cacheBean" class="org.springframework.aop.framework.ProxyFactoryBean">
    <property name="proxyInterfaces">
      <value>de.berlios.sventon.repository.cache.Cache</value>
    </property>
    <property name="target">
      <ref local="cache"/>
    </property>
    <property name="interceptorNames">
      <list>
        <value>cacheBeforeAdvisor</value>
      </list>
    </property>
  </bean>

  <!-- Advisor pointcut definition for before advice -->
  <bean id="cacheBeforeAdvisor" class="org.springframework.aop.support.RegexpMethodPointcutAdvisor">
    <property name="advice">
      <ref local="cacheBeforeAdvice"/>
    </property>
    <property name="pattern">
      <value>.*</value>
    </property>
  </bean>

  <!-- Advice classes -->
  <bean id="cacheBeforeAdvice" class="de.berlios.sventon.repository.cache.CacheBeforeAdvice">
    <property name="revisionObservable">
      <ref local="revisionObservable"/>
    </property>
  </bean>

  <bean id="cache" class="de.berlios.sventon.repository.cache.CacheImpl">
    <property name="entryCache">
      <ref local="entryCache"/>
    </property>
    <property name="logMessageCache">
      <ref local="logMessageCache"/>
    </property>
    <property name="revisionCache">
      <ref local="revisionCache"/>
    </property>
  </bean>

  <!-- Monitors the repository and polls for changes -->
  <bean id="revisionObservable" class="de.berlios.sventon.repository.RevisionObservableImpl">
    <constructor-arg>
      <ref local="observerList"/>
    </constructor-arg>
    <property name="configuration">
      <ref local="configuration"/>
    </property>
    <property name="objectCache">
      <ref local="objectCache"/>
    </property>
    <property name="repositoryService">
      <ref local="repositoryService"/>
    </property>
  </bean>

  <!-- List of RevisionObservers registered to get repository changes -->
  <bean id="observerList" class="java.util.ArrayList">
    <constructor-arg>
      <list>
        <ref local="entryCacheUpdater"/>
        <ref local="logMessageCacheUpdater"/>
        <ref local="revisionCacheUpdater"/>
      </list>
    </constructor-arg>
  </bean>

  <!-- Updater class for applying repository changes to cache -->
  <bean id="revisionCacheUpdater" class="de.berlios.sventon.repository.cache.revisioncache.RevisionCacheUpdater">
    <constructor-arg>
      <ref local="revisionCache"/>
    </constructor-arg>
  </bean>

  <!-- The revisionCache implementation class -->
  <bean id="revisionCache" class="de.berlios.sventon.repository.cache.revisioncache.RevisionCacheImpl">
    <property name="objectCache">
      <ref local="objectCache"/>
    </property>
  </bean>

  <!-- Updater class for applying repository changes to cache -->
  <bean id="entryCacheUpdater" class="de.berlios.sventon.repository.cache.entrycache.EntryCacheUpdater">
    <constructor-arg>
      <ref local="entryCache"/>
    </constructor-arg>
    <property name="configuration">
      <ref local="configuration"/>
    </property>
  </bean>

  <!-- The entryCache implementation class -->
  <bean id="entryCache" class="de.berlios.sventon.repository.cache.entrycache.DiskCache" destroy-method="shutdown">
    <constructor-arg>
      <ref local="sventonCacheDir"/>
    </constructor-arg>
  </bean>

  <!-- Updater class for applying repository changes to cache -->
  <bean id="logMessageCacheUpdater" class="de.berlios.sventon.repository.cache.logmessagecache.LogMessageCacheUpdater">
    <constructor-arg>
      <ref local="logMessageCache"/>
    </constructor-arg>
  </bean>

  <!-- The logMessageCache implementation class -->
  <bean id="logMessageCache" class="de.berlios.sventon.repository.cache.logmessagecache.LogMessageCacheImpl">
    <constructor-arg>
      <ref local="luceneDirectory"/>
    </constructor-arg>
  </bean>

  <bean id="luceneDirectory" class="de.berlios.sventon.repository.cache.logmessagecache.LuceneDirectoryBean">
    <property name="diskPersistent">
      <value>true</value>
    </property>
    <property name="path">
      <ref local="sventonCacheDir"/>
    </property>
  </bean>

  <bean id="exportFileCleaner" class="de.berlios.sventon.repository.export.ExportFileCleaner">
    <property name="exportRootDir">
      <ref local="sventonExportDir"/>
    </property>
    <property name="timeThreshold">
      <value>600000</value>
    </property>
  </bean>

  <bean id="colorer" class="de.berlios.sventon.colorer.JHighlightColorer">
    <property name="encoding">
      <ref local="defaultEncoding"/>
    </property>
    <property name="rendererMappings">
      <map>
        <entry key="java" value-ref="javaXhtmlRenderer"/>
        <entry key="beanshell" value-ref="javaXhtmlRenderer"/>
        <entry key="bsh" value-ref="javaXhtmlRenderer"/>
        <entry key="html" value-ref="xmlXhtmlRenderer"/>
        <entry key="htm" value-ref="xmlXhtmlRenderer"/>
        <entry key="xml" value-ref="xmlXhtmlRenderer"/>
        <entry key="xhtml" value-ref="xmlXhtmlRenderer"/>
        <entry key="lzx" value-ref="xmlXhtmlRenderer"/>
        <entry key="cpp" value-ref="cppXhtmlRenderer"/>
        <entry key="cxx" value-ref="cppXhtmlRenderer"/>
        <entry key="c++" value-ref="cppXhtmlRenderer"/>
        <entry key="c" value-ref="cppXhtmlRenderer"/>
        <entry key="groovy" value-ref="groovyXhtmlRenderer"/>
      </map>
    </property>
  </bean>

  <bean id="javaXhtmlRenderer" class="com.uwyn.jhighlight.renderer.JavaXhtmlRenderer"/>
  <bean id="xmlXhtmlRenderer" class="com.uwyn.jhighlight.renderer.XmlXhtmlRenderer"/>
  <bean id="cppXhtmlRenderer" class="com.uwyn.jhighlight.renderer.CppXhtmlRenderer"/>
  <bean id="groovyXhtmlRenderer" class="com.uwyn.jhighlight.renderer.GroovyXhtmlRenderer"/>

  <bean id="scheduler" class="org.springframework.scheduling.quartz.SchedulerFactoryBean">
    <property name="waitForJobsToCompleteOnShutdown" value="true"/>
    <property name="triggers">
      <list>
        <ref local="cacheUpdateTrigger"/>
        <ref local="exportFileCleanerTrigger"/>
      </list>
    </property>
  </bean>

  <bean id="cacheUpdateTrigger" class="org.springframework.scheduling.quartz.SimpleTriggerBean">
    <property name="jobDetail">
      <ref local="cacheUpdateJobDetail"/>
    </property>
    <property name="startDelay" value="0"/>
    <property name="repeatInterval" value="600000"/>
  </bean>

  <bean id="exportFileCleanerTrigger" class="org.springframework.scheduling.quartz.SimpleTriggerBean">
    <property name="jobDetail">
      <ref local="exportFileCleanerJobDetail"/>
    </property>
    <property name="startDelay" value="300000"/>
    <property name="repeatInterval" value="600000"/>
  </bean>

  <bean id="cacheUpdateJobDetail" class="org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean">
    <property name="targetObject" ref="revisionObservable"/>
    <property name="targetMethod" value="update"/>
  </bean>

  <bean id="exportFileCleanerJobDetail" class="org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean">
    <property name="targetObject" ref="exportFileCleaner"/>
    <property name="targetMethod" value="clean"/>
  </bean>

</beans>
